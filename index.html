<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<title>Star Wars Galaxy — v8</title>
<style>
:root{
  --bg1:#081a3a; --bg2:#0b2858; --bg3:#071633;
  --grid:#24487d; --gridFaint:#1a3a67;
  --panel:#0a1f46e6; --text:#e9f1ff; --muted:#a9bde0;
  /* Region colors (vibrant like the poster) */
  --deep:#ffe88a; --core:#ff89c6; --colonies:#ffb370; --inner:#d990ff;
  --exp:#6bf0d8; --mid:#7fb7ff; --outer:#6580ff; --unk:#c59cff;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:radial-gradient(1200px 900px at 20% -10%, var(--bg2) 0%, var(--bg1) 45%, var(--bg3) 80%) fixed;color:var(--text);font:15px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Cantarell,Helvetica,Arial}
header{position:fixed;top:12px;left:16px;right:16px;z-index:20;display:flex;gap:12px;align-items:center}
.brand{display:flex;flex-direction:column;font-weight:800;letter-spacing:.08em}
.brand .sw{font-size:16px}
.brand .sub{font-size:12px;color:var(--muted);margin-top:-2px}
.controls{margin-left:auto;display:flex;gap:8px;align-items:center;background:linear-gradient(180deg,#0d2a5c,#0b234c);padding:8px 10px;border-radius:10px;border:1px solid #12396c;backdrop-filter:blur(6px)}
.controls input,.controls select,.controls button{background:#0a2148;border:1px solid #1b3e74;color:var(--text);padding:8px 10px;border-radius:8px}
.controls input{min-width:220px}
.controls button{cursor:pointer}
.wrap{position:fixed;inset:0;overflow:hidden}
#map{position:absolute;inset:0;width:100%;height:100%}
#coords{position:fixed;right:12px;bottom:12px;opacity:.85;font-size:12px;color:var(--muted);z-index:15}
#legend{position:fixed;left:12px;bottom:12px;z-index:15;background:var(--panel);padding:10px 12px;border-radius:12px;border:1px solid #1b3f78;backdrop-filter:blur(6px)}
.legend-row{display:flex;gap:12px;align-items:center;margin:2px 0}
.swatch{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;box-shadow:0 0 10px rgba(255,255,255,.18)}
.swatch.deepcore{background:var(--deep)} .swatch.core{background:var(--core)}
.swatch.colonies{background:var(--colonies)} .swatch.inner{background:var(--inner)}
.swatch.exp{background:var(--exp)} .swatch.mid{background:var(--mid)}
.swatch.outer{background:var(--outer)} .swatch.unk{background:var(--unk)}
#routesBar{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;z-index:15;display:flex;gap:8px;flex-wrap:wrap;max-width:80vw;justify-content:center}
.routeTag{background:#0a2148;border:1px solid #2b4d86;border-radius:100px;padding:6px 10px;color:var(--text);cursor:pointer}
.routeTag.active{box-shadow:0 0 12px rgba(255,255,255,.15),0 0 0 1px #fff inset}
/* Edge letters/numbers */
#edgeLabels{position:fixed;inset:0;pointer-events:none;z-index:10;display:grid;grid-template-columns:1fr auto 1fr;grid-template-rows:1fr auto 1fr}
.edge{color:#8fb6ff;font-size:12px;user-select:none}
.top,.bottom{grid-column:1/4;display:flex;justify-content:space-between;padding:0 18vw}
.left,.right{grid-row:1/4;display:flex;flex-direction:column;justify-content:space-between;padding:18vh 0;align-items:center}
/* Datapad popup */
dialog{border:none;background:transparent}
.datapad{width:min(440px,92vw);background:#091e41f0;border:1px solid #58f1ff;border-radius:14px;box-shadow:0 10px 50px rgba(0,0,0,.5),0 0 20px #00ffe64d;overflow:hidden}
.dHead{display:flex;align-items:center;justify-content:space-between;background:linear-gradient(180deg,#0c2a5a,#07224a);border-bottom:1px solid #1a4378;padding:10px 12px}
.dHead h3{margin:0;font-size:20px}
.aure{font-family:monospace;color:#8fe8ff;letter-spacing:.2em;font-size:10px;opacity:.8;display:block}
.tag{font-size:11px;padding:2px 8px;border-radius:100px;border:1px solid #2b5d9a;margin-left:6px;background:#0a2a5c}
.dBody{padding:12px 14px;max-height:62vh;overflow:auto}
.meta{display:grid;grid-template-columns:1fr 1fr;gap:6px 10px;color:#cbe2ff;margin-bottom:6px}
blockquote{margin:8px 0;padding:6px 10px;border-left:3px solid #58f1ff;color:#eaf7ff;font-style:italic}
cite{display:block;margin-top:4px;color:#bcd7ff;font-size:12px}
.notes{color:#d7e7ff}
.closeBtn{background:#123a76;border:1px solid #2a5db0;color:#e6f3ff;border-radius:7px;padding:6px 10px;cursor:pointer}
footer small{position:fixed;left:12px;bottom:48px;opacity:.6;z-index:15}
@media (max-width:760px){ .controls input{min-width:150px} }
</style>
</head>
<body>
<header>
  <div class="brand"><span class="sw">STAR WARS</span><span class="sub">GALAXY MAP</span></div>
  <div class="controls">
    <input id="search" type="search" placeholder="Search planets…" aria-label="Search planets">
    <select id="regionFilter" aria-label="Jump to region">
      <option value="">All regions</option>
      <option>Deep Core</option><option>Core</option><option>Colonies</option>
      <option>Inner Rim</option><option>Expansion Region</option>
      <option>Mid Rim</option><option>Outer Rim</option><option>Unknown Regions</option>
    </select>
    <button id="togglePanel">List</button>
    <button id="reset" onclick="location.reload()">Reset</button>
  </div>
</header>

<div class="wrap">
  <canvas id="map"></canvas>

  <!-- Edge grid labels -->
  <div id="edgeLabels">
    <div class="edge top"></div>
    <div class="edge" style="grid-row:2;grid-column:2"></div>
    <div class="edge bottom"></div>
    <div class="edge left"></div>
    <div class="edge right"></div>
  </div>

  <div id="coords">—</div>

  <div id="legend">
    <div class="legend-row">
      <span class="swatch deepcore"></span>Deep Core
      <span class="swatch core"></span>Core
      <span class="swatch colonies"></span>Colonies
      <span class="swatch inner"></span>Inner Rim
    </div>
    <div class="legend-row">
      <span class="swatch exp"></span>Expansion
      <span class="swatch mid"></span>Mid Rim
      <span class="swatch outer"></span>Outer Rim
      <span class="swatch unk"></span>Unknown Regions
    </div>
  </div>

  <div id="routesBar"></div>
</div>

<aside id="panel" hidden style="position:fixed;right:10px;top:70px;bottom:10px;width:320px;background:var(--panel);border:1px solid #1b3f78;border-radius:14px;backdrop-filter: blur(6px);overflow:auto;z-index:16">
  <div class="head" style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #163a65"><h2 style="margin:0;font-size:16px">Planets</h2><button id="closePanel" class="closeBtn">Close</button></div>
  <ul id="list" style="list-style:none;margin:0;padding:8px 12px"></ul>
</aside>

<dialog id="details">
  <form method="dialog" class="datapad">
    <header class="dHead">
      <div>
        <span class="aure">AUREBESH DATAPAD</span>
        <h3 id="dName">Planet</h3>
      </div>
      <div><span id="dRegion" class="tag">REGION</span> <button id="dClose" value="close" class="closeBtn" aria-label="Close">×</button></div>
    </header>
    <div class="dBody">
      <div class="meta">
        <div><strong>Grid:</strong> <span id="dGrid"></span></div>
        <div><strong>Famous:</strong> <span id="dFamous"></span></div>
      </div>
      <blockquote id="dQuote"></blockquote>
      <cite id="dCite"></cite>
      <p id="dNotes" class="notes"></p>
      <div class="routes">
        <div class="rHead">Trade routes</div>
        <ul id="dRoutes"></ul>
      </div>
    </div>
  </form>
</dialog>

<footer>
  <small>v8 — strong region colors, deep zoom, edge grid labels, clickable routes, improved search & datapad</small>
</footer>

<script>

// v8 single-file: strong region colors, deep zoom, grid labels on edges, clickable routes, improved popups, working search
const DATA = {"planets": [{"name": "Coruscant", "x": 40, "y": -20, "region": "Core", "famous": "Sheev Palpatine", "quote": "I am the Senate.", "by": "Palpatine", "trivia": "Ecumenopolis capital of the Republic and later the Empire; home of the Jedi Temple.", "routes": ["Perlemian Trade Route", "Corellian Run", "Hydian Way"]}, {"name": "Alderaan", "x": -60, "y": -40, "region": "Core", "famous": "Bail Organa", "quote": "You may fire when ready.", "by": "Grand Moff Tarkin", "trivia": "Peaceful Core world destroyed by the first Death Star.", "routes": ["Perlemian Trade Route"]}, {"name": "Corellia", "x": 120, "y": -30, "region": "Core", "famous": "Han Solo", "quote": "Never tell me the odds.", "by": "Han Solo", "trivia": "Shipbuilding powerhouse; birthplace of the Millennium Falcon and CEC.", "routes": ["Corellian Run", "Corellian Trade Spine"]}, {"name": "Chandrila", "x": -10, "y": -60, "region": "Core", "famous": "Mon Mothma", "quote": "I show you the stone in my hand. You miss it because you're looking for a whole army.", "by": "Luthen Rael", "trivia": "Birthplace of Mon Mothma; a founding world of the New Republic.", "routes": ["Perlemian Trade Route"]}, {"name": "Naboo", "x": 220, "y": 120, "region": "Mid Rim", "famous": "Padm\u00e9 Amidala", "quote": "So this is how liberty dies\u2026 with thunderous applause.", "by": "Padm\u00e9 Amidala", "trivia": "Lush world of the Gungans and Theed; represented by Padm\u00e9 and later Palpatine.", "routes": ["Perlemian Trade Route"]}, {"name": "Tatooine", "x": 420, "y": 180, "region": "Outer Rim", "famous": "Luke Skywalker", "quote": "I don't like sand.", "by": "Anakin Skywalker", "trivia": "Remote desert world ruled by Hutt cartels; childhood home of Anakin and Luke.", "routes": ["Corellian Run"]}, {"name": "Jakku", "x": 480, "y": 40, "region": "Outer Rim", "famous": "Rey", "quote": "I\u2019m no one.", "by": "Rey", "trivia": "Desert planet littered with wrecks from the Battle of Jakku; Rey scavenged here.", "routes": ["Corellian Run"]}, {"name": "Bespin", "x": 80, "y": 480, "region": "Outer Rim", "famous": "Lando Calrissian", "quote": "This deal is getting worse all the time.", "by": "Lando Calrissian", "trivia": "Gas giant hosting Cloud City, a tibanna mining colony.", "routes": ["Rimma Trade Route"]}, {"name": "Hoth", "x": -160, "y": 520, "region": "Outer Rim", "famous": "Leia Organa", "quote": "Echo Station 3-T-Eight, we have spotted Imperial walkers!", "by": "Rebel Scout", "trivia": "Frozen world where the Rebel Alliance established Echo Base.", "routes": []}, {"name": "Endor", "x": 300, "y": 520, "region": "Outer Rim", "famous": "Wicket W. Warrick", "quote": "Yub nub.", "by": "Ewoks", "trivia": "Forest moon of the Ewoks; site of the second Death Star\u2019s destruction.", "routes": ["Rimma Trade Route"]}, {"name": "Dagobah", "x": -220, "y": 260, "region": "Outer Rim", "famous": "Yoda", "quote": "Do. Or do not. There is no try.", "by": "Yoda", "trivia": "Swamp world where Yoda lived in exile and trained Luke.", "routes": []}, {"name": "Mustafar", "x": 300, "y": 260, "region": "Outer Rim", "famous": "Darth Vader", "quote": "You were the Chosen One!", "by": "Obi-Wan Kenobi", "trivia": "Volcanic world; site of Anakin and Obi-Wan\u2019s duel.", "routes": []}, {"name": "Geonosis", "x": 260, "y": 140, "region": "Outer Rim", "famous": "Poggle the Lesser", "quote": "The plans you refer to will soon be back in our hands.", "by": "Krennic", "trivia": "Hive world where the Clone Wars began; Death Star prototyping.", "routes": ["Corellian Run"]}, {"name": "Kamino", "x": 500, "y": 260, "region": "Outer Rim", "famous": "Jango Fett", "quote": "Bounty hunter? A complicated profession.", "by": "The Client", "trivia": "Ocean world; Kaminoans created the Grand Army of the Republic.", "routes": []}, {"name": "Kashyyyk", "x": 160, "y": 220, "region": "Mid Rim", "famous": "Chewbacca", "quote": "Aaaaaaargh!", "by": "Chewbacca", "trivia": "Wookiee homeworld of wroshyr forests; invaded after Order 66.", "routes": ["Perlemian Trade Route"]}, {"name": "Mon Cala", "x": 120, "y": 360, "region": "Outer Rim", "famous": "Admiral Ackbar", "quote": "It\u2019s a trap!", "by": "Admiral Ackbar", "trivia": "Oceanic world home to the Mon Calamari and Quarren; key Rebel shipyards.", "routes": ["Rimma Trade Route"]}, {"name": "Scarif", "x": 200, "y": 420, "region": "Outer Rim", "famous": "Jyn Erso", "quote": "Rebellions are built on hope.", "by": "Jyn Erso", "trivia": "Imperial archive world where the Death Star plans were stolen.", "routes": ["Rimma Trade Route"]}, {"name": "Jedha", "x": 80, "y": 120, "region": "Mid Rim", "famous": "Chirrut \u00cemwe", "quote": "I am one with the Force and the Force is with me.", "by": "Chirrut \u00cemwe", "trivia": "Desert moon sacred to believers in the Force; partially destroyed by the Death Star.", "routes": []}, {"name": "Ilum", "x": -100, "y": 100, "region": "Unknown Regions", "famous": "Jedi Order", "quote": "The crystal chooses the Jedi, not the other way around.", "by": "Tera Sinube", "trivia": "Kyber crystal world later hollowed out as Starkiller Base.", "routes": []}, {"name": "Exegol", "x": -420, "y": 60, "region": "Unknown Regions", "famous": "Darth Sidious", "quote": "The dark side of the Force is a pathway to many abilities\u2026", "by": "Palpatine", "trivia": "Hidden Sith world in the Unknown Regions; site of the Final Order fleet.", "routes": []}, {"name": "Ahch-To", "x": -520, "y": 160, "region": "Unknown Regions", "famous": "Luke Skywalker", "quote": "Reach out with your feelings.", "by": "Luke Skywalker", "trivia": "Ocean world of rocky islands; site of the first Jedi Temple.", "routes": []}, {"name": "Batuu", "x": -480, "y": 260, "region": "Unknown Regions", "famous": "Vi Moradi", "quote": "Bright suns!", "by": "Black Spire Outpost", "trivia": "Frontier world on the edge of Wild Space; home of Black Spire Outpost.", "routes": []}, {"name": "Crait", "x": 20, "y": 460, "region": "Outer Rim", "famous": "Leia Organa", "quote": "We are the spark that\u2019ll light the fire\u2026", "by": "Poe Dameron", "trivia": "Salt flat world used by the Resistance as an emergency base.", "routes": []}, {"name": "Lothal", "x": 380, "y": 80, "region": "Outer Rim", "famous": "Ezra Bridger", "quote": "If I have to do this, I\u2019m doing it my way.", "by": "Ezra Bridger", "trivia": "Agrarian world occupied by the Empire; home of the Spectres.", "routes": []}, {"name": "Mandalore", "x": 260, "y": 60, "region": "Outer Rim", "famous": "Bo-Katan Kryze", "quote": "This is the Way.", "by": "The Armorer", "trivia": "Planet of the Mandalorians; devastated then reclaimed.", "routes": []}, {"name": "Ryloth", "x": 220, "y": 200, "region": "Outer Rim", "famous": "Hera Syndulla", "quote": "We have hope. Hope that things can get better.", "by": "Hera Syndulla", "trivia": "Twi\u2019lek homeworld with harsh day-night extremes; long resisted occupation.", "routes": ["Corellian Run"]}, {"name": "Yavin 4", "x": 120, "y": 440, "region": "Outer Rim", "famous": "Cassian Andor", "quote": "Everything I did, I did for the Rebellion.", "by": "Cassian Andor", "trivia": "Jungle moon that hosted a Rebel base; Battle of Yavin staging ground.", "routes": []}, {"name": "Dathomir", "x": -80, "y": 200, "region": "Outer Rim", "famous": "Mother Talzin", "quote": "My loyal Nightsisters\u2026", "by": "Mother Talzin", "trivia": "Remote world of the Nightsisters and rancors; steeped in dark magick.", "routes": []}, {"name": "Hosnian Prime", "x": 20, "y": -120, "region": "Core", "famous": "Poe Dameron", "quote": "Today is the end of the Republic!", "by": "General Hux", "trivia": "Capital of the New Republic destroyed by Starkiller Base.", "routes": ["Perlemian Trade Route"]}, {"name": "Ord Mantell", "x": 260, "y": 260, "region": "Mid Rim", "famous": "Cid", "quote": "You came to the right place, kid.", "by": "Cid", "trivia": "Smuggler-friendly world visited by the Bad Batch.", "routes": ["Corellian Run"]}, {"name": "Takodana", "x": 220, "y": 20, "region": "Mid Rim", "famous": "Maz Kanata", "quote": "The belonging you seek is not behind you; it is ahead.", "by": "Maz Kanata", "trivia": "Ancient castle world where Rey encounters the Skywalker lightsaber.", "routes": []}, {"name": "Cantonica", "x": 360, "y": -20, "region": "Outer Rim", "famous": "DJ", "quote": "They blow you up today, you blow them up tomorrow. It\u2019s just business.", "by": "DJ", "trivia": "Casino world of Canto Bight.", "routes": []}, {"name": "Kessel", "x": 440, "y": 60, "region": "Outer Rim", "famous": "Qi\u2019ra", "quote": "I\u2019ve got a really good feeling about this.", "by": "Han Solo", "trivia": "Spice-mining world; infamous Kessel Run via the Maelstrom.", "routes": ["Corellian Run"]}, {"name": "Polis Massa", "x": -60, "y": 420, "region": "Outer Rim", "famous": "Obi-Wan Kenobi", "quote": "There is good in him. I know there is\u2026", "by": "Padm\u00e9 Amidala", "trivia": "Asteroid colony where Luke and Leia were born.", "routes": []}, {"name": "Felucia", "x": 140, "y": 300, "region": "Outer Rim", "famous": "Aayla Secura", "quote": "Execute Order 66.", "by": "Palpatine", "trivia": "Bioluminescent jungle world; Aayla Secura died here during Order 66.", "routes": []}, {"name": "Corulag", "x": -20, "y": -40, "region": "Core", "famous": "Wilhuff Tarkin", "quote": "The regional governors now have direct control over their territories.", "by": "Palpatine", "trivia": "Core world near Coruscant with Imperial academies.", "routes": []}, {"name": "Byss", "x": -120, "y": -60, "region": "Deep Core", "famous": "Palpatine", "quote": "The dark side is strong here.", "by": "Palpatine", "trivia": "Deep Core fortress world in Legends; included here as mythic reference.", "routes": []}, {"name": "Balmorra", "x": 60, "y": -10, "region": "Colonies", "famous": "", "quote": "", "by": "", "trivia": "", "routes": []}, {"name": "Brentaal", "x": -10, "y": -10, "region": "Core", "famous": "", "quote": "", "by": "", "trivia": "", "routes": []}, {"name": "Malastare", "x": 200, "y": 160, "region": "Mid Rim", "famous": "", "quote": "", "by": "", "trivia": "", "routes": []}, {"name": "Sullust", "x": 160, "y": 380, "region": "Outer Rim", "famous": "", "quote": "", "by": "", "trivia": "", "routes": []}, {"name": "Taris", "x": 320, "y": 120, "region": "Outer Rim", "famous": "", "quote": "", "by": "", "trivia": "", "routes": []}, {"name": "Rodia", "x": 240, "y": 220, "region": "Outer Rim", "famous": "", "quote": "", "by": "", "trivia": "", "routes": []}, {"name": "Saleucami", "x": 180, "y": 260, "region": "Outer Rim", "famous": "", "quote": "", "by": "", "trivia": "", "routes": []}, {"name": "Utapau", "x": 140, "y": 240, "region": "Outer Rim", "famous": "", "quote": "", "by": "", "trivia": "", "routes": []}, {"name": "Haruun Kal", "x": 40, "y": 300, "region": "Mid Rim", "famous": "", "quote": "", "by": "", "trivia": "", "routes": []}, {"name": "Neimoidia", "x": 40, "y": 40, "region": "Colonies", "famous": "", "quote": "", "by": "", "trivia": "", "routes": []}, {"name": "Kuat", "x": 30, "y": -30, "region": "Core", "famous": "", "quote": "", "by": "", "trivia": "", "routes": []}, {"name": "Araxes", "x": 100, "y": 60, "region": "Expansion Region", "famous": "", "quote": "", "by": "", "trivia": "", "routes": []}, {"name": "Eriadu", "x": 120, "y": 280, "region": "Outer Rim", "famous": "", "quote": "", "by": "", "trivia": "", "routes": []}, {"name": "Cato Neimoidia", "x": 60, "y": 20, "region": "Colonies", "famous": "", "quote": "", "by": "", "trivia": "", "routes": []}, {"name": "Bothawui", "x": 60, "y": 200, "region": "Mid Rim", "famous": "", "quote": "", "by": "", "trivia": "", "routes": []}], "routes": [{"name": "Perlemian Trade Route", "color": "#ffd166", "pts": [[-100, -80], [0, -40], [80, 0], [140, 60], [200, 120], [260, 180]]}, {"name": "Corellian Run", "color": "#80eaff", "pts": [[20, -40], [120, -30], [180, 40], [220, 120], [260, 140], [320, 180], [420, 180], [500, 260]]}, {"name": "Hydian Way", "color": "#ff7a7a", "pts": [[-200, 480], [-160, 320], [-40, 160], [40, 0], [120, -80], [240, -160]]}, {"name": "Rimma Trade Route", "color": "#9db4ff", "pts": [[-60, 460], [80, 480], [160, 420], [220, 360], [300, 520]]}, {"name": "Corellian Trade Spine", "color": "#9ef1b0", "pts": [[120, -30], [140, 40], [160, 120], [180, 220], [200, 300]]}]};

const canvas = document.getElementById('map');
const ctx = canvas.getContext('2d');
const routesBar = document.getElementById('routesBar');
const search = document.getElementById('search');
const regionFilter = document.getElementById('regionFilter');
const coordsOut = document.getElementById('coords');
// edge labels
const edgeLabels = document.getElementById('edgeLabels');
const lTop = edgeLabels.querySelector('.top');
const lBottom = edgeLabels.querySelector('.bottom');
const lLeft = edgeLabels.querySelector('.left');
const lRight = edgeLabels.querySelector('.right');

// Camera
const state = {
  w: innerWidth, h: innerHeight,
  scale: 6.2,           // start very close in
  minScale: 1.2,        // can zoom far out to see the full galaxy
  maxScale: 14.0,       // can zoom way in
  x: -20, y: 20,        // camera center in galaxy coords
  dragging: false, lx:0, ly:0,
  planets: DATA.planets,
  routes: DATA.routes,
  selectedRoute: null,
};

const REG_COL = {
  "Deep Core":"var(--deep)","Core":"var(--core)","Colonies":"var(--colonies)","Inner Rim":"var(--inner)",
  "Expansion Region":"var(--exp)","Mid Rim":"var(--mid)","Outer Rim":"var(--outer)","Unknown Regions":"var(--unk)"
};

// --- transforms ---
function tx(x){ return ( (x - state.x) * state.scale ) + state.w/2; }
function ty(y){ return ( (y - state.y) * state.scale ) + state.h/2; }
function fromScreen(px,py){ return { x: (px - state.w/2)/state.scale + state.x, y: (py - state.h/2)/state.scale + state.y }; }

// --- starfield ---
function drawStars(){
  const count = 240;
  for(let i=0;i<count;i++){
    const sx = Math.random()*state.w, sy = Math.random()*state.h, r=Math.random()*1.3+.2;
    ctx.globalAlpha = Math.random()*.6+.25;
    ctx.beginPath(); ctx.arc(sx,sy,r,0,Math.PI*2); ctx.fillStyle='#cfe3ff'; ctx.fill();
  }
  ctx.globalAlpha=1;
}

// --- regions ---
function regionShapes(){
  const shapes=[];
  const push=(name,rx,ry,skew,wiggle)=>shapes.push({name,rx,ry,skew,wiggle});
  push('Deep Core',90,70,-6,18);
  push('Core',170,130,-10,20);
  push('Colonies',280,210,-14,22);
  push('Inner Rim',380,280,-16,24);
  push('Expansion Region',520,360,-14,22);
  push('Mid Rim',670,450,-10,18);
  push('Outer Rim',840,560,-6,16);
  return shapes;
}

function drawRegion(shape){
  const col = getComputedStyle(document.documentElement).getPropertyValue(REG_COL[shape.name] ? REG_COL[shape.name].match(/--[a-z]+/)? REG_COL[shape.name] : '' : '') || REG_COL[shape.name];
  const color = REG_COL[shape.name];
  ctx.save(); ctx.translate(tx(0), ty(0)); ctx.beginPath();
  const rx=shape.rx*state.scale, ry=shape.ry*state.scale;
  const skew = shape.skew*Math.PI/180;
  for(let a=0;a<=Math.PI*2+0.01;a+=Math.PI/64){
    const ca=Math.cos(a), sa=Math.sin(a);
    let x = ca*rx + Math.sin(a*3)*shape.wiggle*state.scale;
    let y = sa*ry + Math.cos(a*2)*(shape.wiggle*0.7)*state.scale;
    const sx = x + Math.tan(skew)*y, sy=y;
    if(a===0) ctx.moveTo(sx,sy); else ctx.lineTo(sx,sy);
  }
  ctx.closePath();
  ctx.fillStyle = color + '40';
  ctx.strokeStyle = color;
  ctx.lineWidth = 2;
  ctx.fill(); ctx.stroke();
  ctx.restore();
}

function drawUnknown(){
  // Big organic blob on the left side
  const pts=[[-820,80],[-770,-20],[-700,-100],[-600,-140],[-540,-110],[-520,-40],[-520,60],[-540,160],[-600,260],[-700,320],[-780,260],[-820,160]];
  ctx.save(); ctx.beginPath();
  pts.forEach((p,i)=>{ const X=tx(p[0]), Y=ty(p[1]); if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y); });
  ctx.closePath();
  ctx.fillStyle = REG_COL["Unknown Regions"] + '40';
  ctx.strokeStyle = REG_COL["Unknown Regions"];
  ctx.lineWidth = 2; ctx.fill(); ctx.stroke(); ctx.restore();
}

// --- routes ---
function drawRoutes(){
  state.routes.forEach((r,i)=>{
    const active = state.selectedRoute===i;
    ctx.save(); ctx.beginPath();
    r.pts.forEach((p,j)=>{ const X=tx(p[0]), Y=ty(p[1]); if(j===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y); });
    ctx.lineWidth = active? 4: 2;
    ctx.strokeStyle = r.color;
    ctx.shadowColor = r.color;
    ctx.shadowBlur = active? 18: 8;
    ctx.stroke(); ctx.restore();
  });
}
function buildRoutesBar(){
  routesBar.innerHTML='';
  state.routes.forEach((r,i)=>{
    const b=document.createElement('button'); b.className='routeTag'; b.textContent=r.name;
    b.onclick = ()=>{ state.selectedRoute = (state.selectedRoute===i?null:i); if(state.selectedRoute!==null) centerOnPolyline(state.routes[i].pts); render(); };
    routesBar.appendChild(b);
  });
}
function centerOnPolyline(pts){
  let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
  pts.forEach(p=>{ minX=Math.min(minX,p[0]); minY=Math.min(minY,p[1]); maxX=Math.max(maxX,p[0]); maxY=Math.max(maxY,p[1]); });
  state.x=(minX+maxX)/2; state.y=(minY+maxY)/2;
  const pad=80;
  const w=maxX-minX+pad, h=maxY-minY+pad;
  const scaleX=(state.w*0.7)/w, scaleY=(state.h*0.7)/h;
  state.scale = Math.max(state.minScale, Math.min(state.maxScale, Math.min(scaleX,scaleY)));
}

// --- planets ---
function drawPlanets(){
  const font = '12px system-ui';
  state.planets.forEach(pl=>{
    const X=tx(pl.x), Y=ty(pl.y);
    if(X<-80||X>state.w+80||Y<-80||Y>state.h+80) return;
    const col = REG_COL[pl.region]||'#fff';
    ctx.save();
    ctx.beginPath(); ctx.arc(X,Y, 5.2, 0, Math.PI*2);
    ctx.fillStyle = col; ctx.shadowColor=col; ctx.shadowBlur=12; ctx.fill();
    // label with halo
    ctx.font = font; ctx.lineWidth=3; ctx.strokeStyle='rgba(0,0,0,.65)';
    ctx.strokeText(pl.name, X+8, Y-8);
    ctx.fillStyle='#eaf2ff'; ctx.fillText(pl.name, X+8, Y-8);
    ctx.restore();
  });
}

function planetAt(px,py){
  for(const pl of state.planets){
    const X=tx(pl.x), Y=ty(pl.y);
    if(Math.hypot(X-px,Y-py)<10) return pl;
  }
  return null;
}

// --- grid ---
const COLS = "CDEFGHIJKLMNOPQRSTU".split('');
const ROWS = Array.from({length:21},(_,i)=>i+1);

function drawGrid(){
  ctx.save();
  ctx.strokeStyle='rgba(110,160,230,.18)'; ctx.lineWidth=1;
  const minX=fromScreen(0,0).x, maxX=fromScreen(state.w,state.h).x;
  const minY=fromScreen(0,0).y, maxY=fromScreen(state.w,state.h).y;
  const startX=Math.floor(minX/80)*80, endX=Math.ceil(maxX/80)*80;
  const startY=Math.floor(minY/80)*80, endY=Math.ceil(maxY/80)*80;
  for(let x=startX;x<=endX;x+=80){ const X=tx(x); ctx.beginPath(); ctx.moveTo(X,0); ctx.lineTo(X,state.h); ctx.stroke(); }
  for(let y=startY;y<=endY;y+=80){ const Y=ty(y); ctx.beginPath(); ctx.moveTo(0,Y); ctx.lineTo(state.w,Y); ctx.stroke(); }
  ctx.restore();

  // edge labels
  function colIndex(x){ const t=(x+900)/1800; return Math.max(0,Math.min(COLS.length-1, Math.floor(t*COLS.length))); }
  function rowIndex(y){ const t=(y+900)/1800; return Math.max(0,Math.min(ROWS.length-1, Math.floor(t*ROWS.length))); }

  const left = colIndex(fromScreen(0,0).x), right = colIndex(fromScreen(state.w,0).x);
  const top = rowIndex(fromScreen(0,0).y), bottom = rowIndex(fromScreen(0,state.h).y);

  function seq(arr,a,b){
    const step=a<=b?1:-1, out=[];
    for(let i=a;i!=b+step;i+=step) out.push(arr[i]);
    return out;
  }
  const colsSeq = seq(COLS,left,right);
  const rowsSeq = seq(ROWS,top,bottom);

  lTop.innerHTML=''; lBottom.innerHTML=''; lLeft.innerHTML=''; lRight.innerHTML='';
  colsSeq.forEach(c=>{ const s=document.createElement('span'); s.textContent=c; lTop.appendChild(s.cloneNode(true)); lBottom.appendChild(s); });
  rowsSeq.forEach(r=>{ const s=document.createElement('span'); s.textContent=r; lLeft.appendChild(s.cloneNode(true)); lRight.appendChild(s); });
}

// --- popup ---
const details = document.getElementById('details');
const dName = document.getElementById('dName');
const dRegion = document.getElementById('dRegion');
const dGrid = document.getElementById('dGrid');
const dFamous = document.getElementById('dFamous');
const dQuote = document.getElementById('dQuote');
const dCite = document.getElementById('dCite');
const dNotes = document.getElementById('dNotes');
const dRoutes = document.getElementById('dRoutes');
const dClose = document.getElementById('dClose');

function showPlanet(pl){
  dName.textContent = pl.name;
  dRegion.textContent = pl.region;
  dRegion.style.borderColor = REG_COL[pl.region]||'#58f1ff';
  // compute grid cell
  const cIdx = Math.max(0,Math.min(COLS.length-1, Math.floor(((pl.x+900)/1800)*COLS.length)));
  const rIdx = Math.max(0,Math.min(ROWS.length-1, Math.floor(((pl.y+900)/1800)*ROWS.length)));
  dGrid.textContent = `${COLS[cIdx]}-${ROWS[rIdx]}`;
  dFamous.textContent = pl.famous||'—';
  dQuote.textContent = pl.quote||'';
  dCite.textContent = pl.by? `— ${pl.by}` : '';
  dNotes.textContent = pl.trivia||'';
  dRoutes.innerHTML='';
  (pl.routes||[]).forEach(r=>{ const li=document.createElement('li'); li.textContent=r; dRoutes.appendChild(li); });
  details.showModal();
}
dClose.onclick = ()=> details.close();

// --- input ---
canvas.addEventListener('mousedown',e=>{ state.dragging=true; state.lx=e.clientX; state.ly=e.clientY; });
window.addEventListener('mouseup',()=>state.dragging=false);
window.addEventListener('mousemove',e=>{
  if(!state.dragging) return;
  const dx=(e.clientX-state.lx)/state.scale, dy=(e.clientY-state.ly)/state.scale;
  state.x -= dx; state.y -= dy; state.lx=e.clientX; state.ly=e.clientY; render();
});
canvas.addEventListener('wheel',e=>{
  e.preventDefault();
  const pre=fromScreen(e.clientX,e.clientY);
  const factor = Math.pow(1.1, -Math.sign(e.deltaY)); // smooth
  state.scale = Math.max(state.minScale, Math.min(state.maxScale, state.scale*factor));
  const post=fromScreen(e.clientX,e.clientY);
  state.x += pre.x-post.x; state.y += pre.y-post.y; render();
},{passive:false});
canvas.addEventListener('click',e=>{
  const pl = planetAt(e.clientX,e.clientY);
  if(pl) showPlanet(pl);
});

// search: Enter jumps to first result; typing opens list panel
const panel = document.getElementById('panel');
const list = document.getElementById('list');
document.getElementById('togglePanel').onclick=()=>panel.hidden=!panel.hidden;
document.getElementById('closePanel').onclick=()=>panel.hidden=true;

function renderList(){
  const q=(search.value||'').toLowerCase();
  const reg=regionFilter.value;
  list.innerHTML='';
  const filtered = state.planets.filter(pl=> pl.name.toLowerCase().includes(q) && (!reg||pl.region===reg) )
                     .sort((a,b)=>a.name.localeCompare(b.name));
  filtered.forEach(pl=>{ const li=document.createElement('li'); li.textContent=`${pl.name} — ${pl.region}`; li.onclick=()=>{ state.x=pl.x; state.y=pl.y; state.scale=10; render(); showPlanet(pl); }; list.appendChild(li); });
  return filtered;
}
search.addEventListener('input',()=>{ panel.hidden=false; renderList(); });
search.addEventListener('keydown',e=>{
  if(e.key==='Enter'){
    const results = renderList();
    if(results.length){ const pl=results[0]; state.x=pl.x; state.y=pl.y; state.scale=10; render(); showPlanet(pl); }
  }
});
regionFilter.addEventListener('change',()=>{ jumpToRegion(regionFilter.value); render(); });

function jumpToRegion(rName){
  const bounds = {'Deep Core':[ -120,-90, 120,90 ],
    'Core':[ -200,-150, 200,150 ],
    'Colonies':[ -300,-220, 300,220 ],
    'Inner Rim':[ -420,-300, 420,300 ],
    'Expansion Region':[ -560,-380, 560,380 ],
    'Mid Rim':[ -720,-460, 720,460 ],
    'Outer Rim':[ -900,-560, 900,560 ],
    'Unknown Regions':[ -820,-160, -300, 360 ],
  }[rName];
  if(!bounds) return;
  const [minX,minY,maxX,maxY]=bounds;
  state.x=(minX+maxX)/2; state.y=(minY+maxY)/2;
  const scaleX=(state.w*0.7)/(maxX-minX);
  const scaleY=(state.h*0.7)/(maxY-minY);
  state.scale = Math.max(state.minScale, Math.min(state.maxScale, Math.min(scaleX,scaleY)));
}

// --- render ---
function render(){
  canvas.width = state.w = innerWidth; canvas.height = state.h = innerHeight;
  ctx.clearRect(0,0,state.w,state.h);
  drawStars();
  drawGrid();
  regionShapes().forEach(drawRegion);
  drawUnknown();
  drawRoutes();
  drawPlanets();
  coordsOut.textContent = `x ${state.x.toFixed(1)}, y ${state.y.toFixed(1)} • zoom ${state.scale.toFixed(2)}`;
  // route tag active state
  Array.from(routesBar.children).forEach((b,i)=> b.classList.toggle('active', state.selectedRoute===i));
}

function init(){
  buildRoutesBar();
  renderList();
  render();
}
window.addEventListener('resize',render);
init();

</script>
</body></html>